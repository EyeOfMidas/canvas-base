<html>
<head>
	<style type="text/css">
		html,body{
			margin: 0;
			padding: 0;
		}
		canvas {
			width: 100%;
			height: 100%;
		}

		#game {
			width: 100%;
			height: 100%;
		}
	</style>
</head>
<body>
	<div id="game"></div>
	<script src="./KeyCode.js"></script>
	<script>
	var canvas;
	var context;
	var lastTime;
	var updateIntervalId;

	var camera = {x: 0, y: 0, center: {x: 0, y: 0}, movementSpeed: 3};
	var keys = [];

	var player = {
		x: 50,
		y: 50,
		width: 20,
		height: 20,
		center: {x: 10, y: 10},
		angle: 90 * Math.PI / 180,
		rotationSpeed: 3 * Math.PI / 180,
		movementSpeed: 3,
	};
	</script>
<script>
	function animate() {
		context.save();
		context.translate(0.5, 0.5);
		clearFrame(context);
		draw(context);
		context.restore();
		requestAnimationFrame(animate);
	}

	function clearFrame(context) {
		context.fillStyle = "#000000";
        context.beginPath();
        context.rect(0, 0, canvas.width, canvas.height);
        context.fill();
    }

	function init() {
		lastTime = new Date().getUTCMilliseconds();
        context = canvas.getContext('2d');

        keys = [];
        for (let i = 0; i < 256; i++) {
        	keys[i] = false;
        }

        onResize();
	}

	function update(delta) {
		updateCamera(delta);
		updateBackground(delta);
		updatePlayer(delta);
		
	}

	function draw(context) {
		context.save();
		context.translate(-camera.x, -camera.y);

		drawBackground(context);
		drawPlayer(context);

		context.restore();
	}

	function onResize() {
		let dpi = window.devicePixelRatio;
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
        context.width = canvas.clientWidth / dpi;
        context.height = canvas.clientHeight / dpi;

        camera.center.x = canvas.width / 2;
        camera.center.y = canvas.height / 2;
	}

	function onKeyDown(event) {
		keys[event.keyCode] = true;
	}

	function onKeyUp(event) {
		keys[event.keyCode] = false;
	}
</script>

<script>
	document.addEventListener("DOMContentLoaded", event => {
		canvas = document.createElement("canvas");
		document.getElementById("game").appendChild(canvas);
		init();
		animate();

		updateIntervalId = setInterval(() => {
			let currentTime = new Date().getUTCMilliseconds();
			update(1 + ((currentTime - lastTime) / 1000));
			lastTime = currentTime;
		}, 16);
	});

	window.addEventListener("resize", onResize);
    window.addEventListener("keydown", onKeyDown);
    window.addEventListener("keyup", onKeyUp);
	
</script>

<script>
	function updateCamera(delta) {
		if(keys[KeyCode.Up]) {
			camera.y += -camera.movementSpeed * delta;
		}

		if(keys[KeyCode.Down]) {
			camera.y += camera.movementSpeed * delta;
		}

		if(keys[KeyCode.Left]) {
			camera.x += -camera.movementSpeed * delta;
		}

		if(keys[KeyCode.Right]) {
			camera.x += camera.movementSpeed * delta;
		}
	}

	function updateBackground(delta) {
		if(camera.y < -1280) {
			camera.y = -1280;
		}

		if(camera.y + canvas.height > 1280) {
			camera.y = 1280 - canvas.height;
		}

		if(camera.x < -1280) {
			camera.x = -1280;
		}

		if(camera.x+ canvas.width > 1280) {
			camera.x = 1280 - canvas.width;
		}

	}

	function drawBackground(context) {
		context.strokeStyle = "limegreen";
		context.lineWidth = 3;
		for(let y = -10; y < 10; y++) {
			for(let x = -10; x < 10; x++) {
				context.beginPath();
				context.rect(x * 128, y * 128, 128, 128);
				context.stroke();
			}	
		}
		
	}

	function updatePlayer(delta) {
		if(keys[KeyCode.W]) {
			player.y += -player.movementSpeed * delta;
		}

		if(keys[KeyCode.S]) {
			player.y += player.movementSpeed * delta;
		}

		if(keys[KeyCode.A]) {
			player.x += -player.movementSpeed * delta;
		}

		if(keys[KeyCode.D]) {
			player.x += player.movementSpeed * delta;
		}

		if(keys[KeyCode.Q]) {
			player.angle -= player.rotationSpeed * delta;
		}

		if(keys[KeyCode.E]) {
			player.angle += player.rotationSpeed * delta;
		}

	}
	function drawPlayer(context) {
		context.save();
		context.fillStyle = "crimson";
		context.translate(player.x, player.y);
		context.rotate(player.angle);
		context.beginPath();
		context.rect(-player.center.x, -player.center.y, player.width, player.height);
		context.fill();
		context.restore();
	}
</script>

</body>
</html>